<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ˆè­·é˜²ç·šï¼šå…’å°‘ä¿è­·å…¨æ­·ç¨‹æ¨¡æ“¬ (SDMå®Œæ•´ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --panel-bg: #2c2c2c;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-blue: #64b5f6;
            --accent-green: #81c784;
            --accent-yellow: #fff176;
            --accent-red: #ef5350;
            --accent-purple: #ce93d8;
            --accent-orange: #ffb74d;
            --border-color: #424242;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 340px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-title { font-size: 1.1rem; color: var(--accent-blue); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .clue-log { font-size: 0.9rem; color: var(--text-muted); flex: 1; }
        .clue-entry { margin-bottom: 10px; padding-left: 10px; border-left: 2px solid var(--accent-yellow); line-height: 1.4; animation: fadeIn 0.5s; }
        .clue-medical { border-left-color: var(--accent-purple); color: #e1bee7; font-weight: bold; }
        .clue-alert { border-left-color: var(--accent-red); color: #ffcdd2; font-weight: bold; }
        .clue-status { border-left-color: var(--accent-blue); background: rgba(100, 181, 246, 0.1); }
        .clue-positive { border-left-color: var(--accent-green); color: #a5d6a7; } 
        .clue-sup { border-left-color: var(--accent-orange); color: #ffe0b2; }

        /* Stats Bar */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; margin-top: 15px;}
        .progress-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .chat-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Messages */
        .msg { max-width: 85%; padding: 15px; border-radius: 10px; line-height: 1.6; animation: fadeIn 0.3s ease; position: relative; }
        .msg-sw { align-self: flex-end; background-color: #1565c0; color: white; border-right: 4px solid #90caf9; text-align: right; }
        .msg-parent { align-self: flex-start; background-color: #424242; border-left: 4px solid var(--accent-yellow); }
        .msg-child { align-self: flex-start; background-color: #2e7d32; border-left: 4px solid var(--accent-green); }
        .msg-doc { align-self: flex-start; background-color: #4a148c; border-left: 4px solid var(--accent-purple); color: #f3e5f5; }
        .msg-sup { align-self: flex-start; background-color: #37474f; border-left: 4px solid var(--accent-orange); color: #eceff1; }
        .msg-sys { align-self: center; background: rgba(255,255,255,0.05); color: #aaa; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; margin: 10px 0; text-align: center;}
        
        .msg-danger { 
            align-self: center; 
            background-color: rgba(239, 83, 80, 0.2); 
            border: 2px solid var(--accent-red); 
            color: #ffcdd2; 
            font-weight: bold;
            text-align: center;
            width: 90%;
        }

        /* Controls */
        #controls {
            padding: 20px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            min-height: 200px;
        }
        .control-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; align-items: center; }
        .group-label { font-size: 0.8rem; color: #888; width: 100%; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }

        button {
            padding: 12px 20px;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            min-width: 140px;
            text-align: left;
            display: flex; flex-direction: column; justify-content: center;
        }
        button:hover { background-color: #555; border-color: var(--accent-blue); transform: translateY(-2px); }
        button small { font-size: 0.8rem; color: #aaa; margin-top: 2px; }
        
        button.primary { background-color: #1565c0; border-color: #1565c0; font-weight: bold; text-align: center; align-items: center;}
        button.highlight { border: 1px solid var(--accent-yellow); color: var(--accent-yellow); }
        button.confront { border: 1px solid var(--accent-red); color: var(--accent-red); background: rgba(229, 115, 115, 0.1); }
        button.medical { border-left: 4px solid var(--accent-purple); }
        button.child-btn { border-left: 4px solid var(--accent-green); }
        
        button.service-btn { 
            border-left: 5px solid var(--accent-blue); 
            background: rgba(33, 150, 243, 0.15); 
            width: 100%;
            align-items: center;
            text-align: center;
            font-weight: bold;
        }
        
        button.sup-btn { border-left: 5px solid var(--accent-orange); background: rgba(255, 183, 77, 0.1); width: 100%; align-items: center;}
        button.finish-btn { background-color: var(--accent-green); color: black; font-weight: bold; width: 100%; text-align: center; align-items: center;}
        button.deadlock-exit { border-left: 5px solid var(--accent-red); background: rgba(244, 67, 54, 0.1); }

        /* Strategy Buttons */
        .btn-soft { border-left: 4px solid var(--accent-green); }
        .btn-hard { border-left: 4px solid var(--accent-red); }
        .btn-fallback { border-left: 4px solid var(--accent-purple); }
        
        /* Negotiation Tactics */
        .btn-empathy { border-left: 4px solid var(--accent-green); }
        .btn-clarify { border-left: 4px solid var(--accent-blue); }
        .btn-flank { border-left: 4px solid var(--accent-purple); }

        /* Phase 2 Buttons */
        .btn-dialogue { min-height: 80px; width: 48%; background-color: #2a2a2a; border: 1px solid #444; align-items: flex-start; }
        .response-grid { display: flex; gap: 10px; justify-content: space-between; width: 100%; }

        /* Modal */
        #assessment-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; padding: 40px; box-sizing: border-box; overflow-y: auto;}
        .form-card { background: var(--card-bg); max-width: 900px; margin: 0 auto; padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); }
        label { display: flex; margin-bottom: 12px; cursor: pointer; line-height: 1.5; border-bottom: 1px solid #333; padding-bottom: 8px; }
        label:hover { background: #2a2a2a; }
        input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); accent-color: var(--accent-green); flex-shrink: 0; margin-top: 4px;}
        h3 { color: var(--accent-blue); border-bottom: 1px dashed #444; padding-bottom: 5px; margin-top: 30px;}

        #view-phase1, #view-phase2 { display: none; height: 100%; flex-direction: column; }
        .active-view { display: flex !important; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<aside>
    <div class="sidebar-title">ğŸ“ å€‹æ¡ˆç‹€æ…‹</div>
    <div style="margin-bottom: 20px;">
        <strong>å…’å°‘ï¼š</strong><span id="info-name">Loading...</span><br>
        <strong>ç…§é¡§è€…ï¼š</strong><span id="info-parent">Loading...</span>
    </div>
    
    <div id="p1-sidebar">
        <div class="sidebar-title">èª¿æŸ¥ç­†è¨˜</div>
        <div id="clue-log" class="clue-log"></div>
    </div>

    <div id="p2-sidebar" style="display:none; border-top:1px solid #444; padding-top:20px;">
        <div class="sidebar-title">å®‰ç½®è™•é‡æŒ‡æ¨™</div>
        <div class="stat-row"><span>ğŸ¤ ä¿¡ä»»é—œä¿‚</span><span id="txt-trust">20%</span></div>
        <div class="progress-bg"><div id="bar-trust" class="progress-fill" style="width:20%; background:var(--accent-green);"></div></div>
        <div class="stat-row"><span>ğŸ“š è¦ªè·èƒ½åŠ›</span><span id="txt-skill">10%</span></div>
        <div class="progress-bg"><div id="bar-skill" class="progress-fill" style="width:10%; background:var(--accent-blue);"></div></div>
        <div class="stat-row"><span>ğŸ“… é€²åº¦</span><span id="txt-month">Month 1/12</span></div>
        <div id="p2-mood-status" style="margin-top:10px; font-size:0.9rem; color:#888;"></div>
    </div>
</aside>

<main>
    <div id="view-phase1" class="active-view">
        <div id="chat-p1" class="chat-container"></div>
        <div id="controls-p1" id="controls"></div>
    </div>

    <div id="view-phase2">
        <div style="padding: 10px 30px; background: #111; border-bottom: 1px solid #333; text-align: center; font-weight: bold; color: var(--accent-blue);">
            å®‰ç½®è™•é‡éšæ®µ (Phase 2)
        </div>
        <div id="chat-p2" class="chat-container"></div>
        <div id="controls-p2" id="controls"></div>
    </div>
</main>

<div id="assessment-modal">
    <div class="form-card">
        <h2 style="color:var(--accent-blue); margin-top:0;">ğŸ“‹ å…’å°‘å®‰å…¨è©•ä¼°è¡¨ (SDM)</h2>
        <form id="sdm-form">
            <h3>A. ç„¡åŠ©ç‹€æ…‹</h3>
            <label><input type="checkbox" id="v1"> 1. 6è¶³æ­²ä»¥ä¸‹</label>
            <label><input type="checkbox" id="v2"> 2. è¢«è¨ºæ–·æˆ–é‘‘å®šå‡ºæœ‰ç”Ÿç†æˆ–å¿ƒç†ç—…ç—‡</label>
            <label><input type="checkbox" id="v3"> 3. åš´é‡çš„è¡Œç‚ºåŠæƒ…ç·’æˆ–å¿ƒç†å•é¡Œ</label>
            <label><input type="checkbox" id="v4"> 4. å—é™çš„ç™¼å±•åŠèªçŸ¥èƒ½åŠ›(ä¾‹å¦‚ï¼šç™¼å±•é²ç·©ã€èªè¨€æå‚·)</label>
            <label><input type="checkbox" id="v5"> 5. å—é™çš„èº«é«”èƒ½åŠ›(ä¾‹å¦‚ï¼šå—æçš„ç§»å‹•èƒ½åŠ›ã€èº«é«”éšœç¤™)</label>
            <label><input type="checkbox" id="v6"> 6. èˆ‡ç¤¾å€éš”é›¢ï¼Œæˆ–å’Œå…¶ä»–æˆäººã€è¦ªå‹çš„æ¥è§¸æœ‰é™</label>

            <h3>B. å±éšªå› ç´ </h3>
            <label><input type="checkbox" id="d1"> 1. ç…§é¡§è€…æˆ–å®¶æˆ¶ä¸­æˆäººå°å…’å°‘é€ æˆåš´é‡çš„èº«é«”å‚·å®³ï¼Œæˆ–æ˜¯å°‡å°ä»–å€‘é€ æˆèº«é«”å‚·å®³</label>
            <label><input type="checkbox" id="d2"> 2. ç…§é¡§è€…å°å…’å°‘æ€§ä¾µå®³ï¼Œæˆ–æœ‰ç…§é¡§è€…è¢«æ‡·ç–‘å°å…’å°‘æ€§ä¾µå®³ã€‚</label>
            <label><input type="checkbox" id="d3"> 3. ç…§é¡§è€…æ²’æœ‰æ»¿è¶³å…’å°‘çš„åŸºæœ¬éœ€æ±‚ï¼Œä»¥è‡´å°å…’å°‘å·²é€ æˆï¼ˆæˆ–å¯èƒ½é€ æˆï¼‰åš´é‡çš„å‚·å®³ã€‚</label>
            <label><input type="checkbox" id="d4"> 4. å±…ä½æ¢ä»¶ä¸ä½³ï¼Œä¸”å°æ–¼å…’å°‘çš„å¥åº·åŠå®‰å…¨æœ‰ç«‹å³çš„å¨è„…ã€‚</label>
            <label><input type="checkbox" id="d5"> 5. ç…§é¡§è€…çš„è¡Œç‚ºå¾ˆå¯èƒ½é€ æˆå…’å°‘åš´é‡çš„å¿ƒç†å‰µå‚·ï¼Œä¸”å…’å°‘å·²è¢«è§€å¯Ÿåˆ°æœ‰åš´é‡çš„å¿ƒç†æˆ–æƒ…ç·’å‰µå‚·ã€‚</label>
            <label><input type="checkbox" id="d6"> 6. ç•¶å…’å°‘é­å—åˆ°ä»–äººåš´é‡å‚·å®³æˆ–å¯èƒ½é­å—ä»–äººåš´é‡å‚·å®³æ™‚ï¼Œç…§é¡§è€…æ²’æœ‰æä¾›é©åˆ‡çš„ä¿è­·ã€‚</label>
            <label><input type="checkbox" id="d7"> 7. æ¡ˆå®¶ä¸æä¾›è®“ç¤¾å·¥èˆ‡å…’å°‘æ¥è§¸çš„ç®¡é“ï¼Œé˜»ç¤™æˆ–é€ƒé¿èª¿æŸ¥çš„é€²è¡Œï¼Œæˆ–æ˜¯æœ‰å…¶ä»–ç†ç”±èªç‚ºæ¡ˆå®¶æœ‰æ¬é›¢çš„æ‰“ç®—ã€‚</label>
            <label><input type="checkbox" id="d8"> 8. ç…§é¡§è€…å°æ–¼å…’å°‘èº«ä¸Šçš„å‚·å®³ç„¡æ³•æå‡ºåˆç†çš„è§£é‡‹ï¼Œæˆ–å°æ–¼æ˜¯å“ªä¸€ç¨®é¡å‹çš„å‚·å®³ï¼Œä»¥åŠå‚·å®³å¦‚ä½•å½¢æˆå‰å¾Œå›ç­”ä¸ä¸€è‡´ï¼Œè¡¨ç¤ºå…’å°‘å¯èƒ½è™•åœ¨ç«‹å³çš„å±éšªç•¶ä¸­ã€‚</label>

            <h3>C. å®‰å…¨è¨ˆç•« (ä¿è­·å› å­)</h3>
            <p style="color:var(--accent-yellow); font-size:0.9rem;">*è‹¥æœ‰å±éšªå› å­ï¼Œä¸”ä¿è­·å› å­3,4,7,8æœªå…¨æ•¸ç¬¦åˆï¼Œå¿…é ˆè€ƒé‡ç·Šæ€¥å®‰ç½®ã€‚</p>
            <label><input type="checkbox" id="p1"> 1. ç…§é¡§è€…çš„è¡Œå‹•ç›´æ¥æ¸›è¼•ç¾å­˜å±éšªå› ç´ çš„å¨è„…ï¼Œåªæ˜¯å°šæœªè­‰æ˜å¯é•·æ™‚é–“å±•ç¾ã€‚</label>
            <label><input type="checkbox" id="p2"> 2. ç…§é¡§è€…åœ¨æ­¤æ¬¡é€šå ±äº‹ä»¶å‰æ›¾æ¡å–è¡Œå‹•ç¢ºä¿å…’å°‘å…æ–¼é¡ä¼¼çš„å±éšªã€‚</label>
            <label><input type="checkbox" id="p3" class="critical"> 3. ç…§é¡§è€…å…·æœ‰èªçŸ¥ã€ç”Ÿç†ã€æƒ…ç·’ä¸Šçš„èƒ½åŠ›å¯åƒèˆ‡å®‰å…¨ç¶­è­·è¡Œå‹•ã€‚</label>
            <label><input type="checkbox" id="p4" class="critical"> 4. ç…§é¡§è€…äº†è§£ä¸¦æ¥å—å±éšªã€‚</label>
            <label><input type="checkbox" id="p5"> 5. ç…§é¡§è€…è­‰æ˜éå»æœ‰èƒ½åŠ›æ»¿è¶³å…’å°‘çš„èº«å¿ƒéœ€æ±‚ï¼Œä¸”æ‰¿è«¾æœªä¾†å°‡ç¹¼çºŒç¶­è­·å…¶èº«å¿ƒå¥å…¨ã€‚</label>
            <label><input type="checkbox" id="p6"> 6. æœ‰äº‹å¯¦é¡¯ç¤ºç…§é¡§è€…èˆ‡å…’å°‘æœ‰å¥åº·è€Œè‰¯å¥½çš„é—œä¿‚ã€‚</label>
            <label><input type="checkbox" id="p7" class="critical"> 7. ç…§é¡§è€…é¡˜æ„ä¸”èƒ½å¤ æ¥å—å®‰å…¨ç¶²çµ¡æˆå“¡çš„å”åŠ©ã€‚</label>
            <label><input type="checkbox" id="p8" class="critical"> 8. è‡³å°‘æœ‰ä¸€ä½å®‰å…¨ç¶²çµ¡æˆå“¡åƒèˆ‡å®‰å…¨è¨ˆç•«ã€‚</label>
        </form>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="document.getElementById('assessment-modal').style.display='none'" style="flex:1">è¿”å›èª¿æŸ¥</button>
            <button class="primary" onclick="submitDecision()" style="flex:2">æäº¤è©•ä¼°ä¸¦è£å®š</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // DATA: PHASE 1 SCENARIOS
    // ==========================================
    const P1_SCENARIOS = [
        {
            id: "hostile", type: "abuse",
            parent: {
                name: "é™³å…ˆç”Ÿ", type: "æ•µæ„æŠ—æ‹’å‹",
                intro: "é€™æ¨£éš¨ä¾¿ä¸€å€‹äººé€šå ±å°±è¦ä¾†èª¿æŸ¥æˆ‘ï¼Ÿä½ å€‘åƒé£½å¤ªé–’å—ï¼Ÿ",
                r_incident: "å°å­©å°±è‡ªå·±å—å‚·çš„è¬›äº†ä½ åˆä¸ä¿¡ï¼",
                r_deadlock: "ä¸ç„¶ä½ å²å®³ä½ å€‘å¸¶èµ°å•Šï¼çœ‹ä½ å€‘å¤šæœƒæ•™ï¼",
                r_child_deny: [ "ä»–åœ¨ç¡è¦ºï¼ä¸å‡†é€²å»ï¼", "é€™æ˜¯æˆ‘çš„å®¶ï¼Œæˆ‘æœ‰æ¬Šåˆ©æ‹’çµ•ï¼", "å¥½å•¦ï¼ç…©æ­»äº†ï¼Œæˆ‘åœ¨æ—é‚Šçœ‹è‘—ã€‚" ],
                confront: "ï¼ˆæ‹æ¡Œï¼‰æ­»å°å­©äº‚è¬›è©±ï¼æˆ‘å›å»ä¿®ç†ä»–ï¼",
                r_service_reject: "æˆ‘ä¸éœ€è¦ï¼ç¥ç¶“ç—…æ‰å»ä¸Šèª²ï¼",
                r_service_fake: "å¥½å•¦...æœ‰ç©ºå†å»ã€‚"
            },
            child: {
                name: "å°æ˜", age: 8, 
                // Child Response Variations
                r: {
                    verify: "æ˜¯çˆ¸çˆ¸æ‰“çš„...ä»–å–é†‰å°±æ‹¿çš®å¸¶...",
                    care: "è‚šå­é¤“...å®¶è£¡æ²’æœ‰æ±è¥¿åƒ...", // Severe lack
                    attach: "ï¼ˆçœ¼ç¥ææ‡¼ï¼Œèº«é«”åƒµç¡¬ï¼‰"
                },
                vuln: ["v3"]
            },
            p2_start: { trust: 10, skill: 10 }
        },
        {
            id: "fake_compliance", type: "abuse",
            parent: {
                name: "ç‹å°å§", type: "å‡æ€§é…åˆå‹",
                intro: "å“å‘€ç¤¾å·¥è€å¸«å¥½ï¼Œè¾›è‹¦äº†ï¼Œé€™é»å°äº‹é‚„éº»ç…©ä½ å€‘ã€‚",
                r_incident: "å–”é‚£å€‹å–”ï¼Œæ˜¯ä»–è‡ªå·±å»æ’åˆ°æ¡Œè§’çš„å•¦ï¼ŒçœŸçš„ã€‚",
                r_deadlock: "æˆ‘å€‘é€™å€‹æ¡ˆä»¶æ¯”è¼ƒç‰¹åˆ¥ï¼Œä¸èƒ½é€šèä¸€ä¸‹å—ï¼Ÿ",
                r_child_deny: ["ä»–åœ¨å¯«åŠŸèª²è€¶ï¼Œç¾åœ¨ä¸æ–¹ä¾¿ã€‚", "å¥½å•¦å¥½å•¦æˆ‘å»å«ã€‚", "å¥½å•¦ã€‚"],
                confront: "å”‰å”·ï¼Œå°å­©å­æƒ³åƒåŠ›è±å¯Œå•¦ï¼Œé‚£æ˜¯è¡£æ¶ä¸å°å¿ƒæ®åˆ°çš„ã€‚",
                r_service_reject: "æˆ‘å¾ˆå¿™è€¶ï¼Œèƒ½ä¸èƒ½ä¸è¦å»ï¼Ÿ",
                r_service_fake: "å¥½å¥½å¥½ï¼Œæˆ‘ä¸€å®šå»ã€‚"
            },
            child: {
                name: "å©·å©·", age: 5,
                r: {
                    verify: "ç—›ç—›...ï¼ˆæŒ‡è‘—èƒŒéƒ¨ï¼‰",
                    care: "éƒ½åƒæ³¡éºµ...æœ‰æ™‚å€™åª½åª½æ‰“ç‰Œæˆ‘å°±æ²’åƒ...", // Neglect
                    attach: "ï¼ˆèº²åœ¨ç¤¾å·¥èº«å¾Œï¼‰"
                },
                vuln: ["v1"]
            },
            p2_start: { trust: 40, skill: 20 }
        },
        {
            id: "low_risk", type: "low",
            parent: {
                name: "æ—å…ˆç”Ÿ", type: "ç©æ¥µé…åˆå‹ (ä½é¢¨éšª)",
                intro: "æ‚¨å¥½ï¼Œè«‹é€²ã€‚æˆ‘çŸ¥é“ä½ å€‘ä¹Ÿæ˜¯ç‚ºäº†å°å­©å¥½ï¼Œæ²’é—œä¿‚ã€‚",
                r_incident: "æ˜¯ä¸Šé€±å»å…¬åœ’æºœç›´æ’è¼ªæ‘”å€’çš„ï¼Œæˆ‘å€‘æœ‰å¸¶å»çœ‹é†«ç”Ÿã€‚",
                r_deadlock: "ï¼ˆå®¶é•·ç†æ€§æºé€šï¼‰",
                r_child_deny: ["ç•¶ç„¶å¯ä»¥ï¼Œä»–åœ¨æˆ¿é–“ã€‚", "å¥½ã€‚", "å¥½ã€‚"],
                confront: "æ˜¯çš„ï¼Œé‚£å¤©çœŸçš„åš‡å£æˆ‘å€‘äº†ï¼Œæˆ‘å€‘ä¹Ÿå¾ˆå¿ƒç–¼ã€‚",
                r_service_reject: "æˆ‘å€‘è‡ªå·±æœƒæ³¨æ„ï¼Œä¸ç”¨éº»ç…©äº†ã€‚",
                r_service_fake: "å¦‚æœå°å­©å­æœ‰å¹«åŠ©ï¼Œæˆ‘å€‘é¡˜æ„é…åˆã€‚"
            },
            child: {
                name: "å°å‚‘", age: 8,
                r: {
                    verify: "æˆ‘è‡ªå·±è·Œå€’çš„å•¦ï¼Œè¶…ç—›çš„ï¼ä½†åª½åª½æœ‰å‘¼å‘¼ã€‚",
                    care: "åª½åª½ç…®é£¯å¾ˆå¥½åƒå–”ï¼è¡£æœä¹Ÿéƒ½æœ‰æ´—é¦™é¦™ã€‚", // Proper care
                    attach: "ï¼ˆè‡ªç„¶åœ°è·‘å»æŠ±ä½å®¶é•·ï¼‰"
                },
                vuln: []
            },
            p2_start: { trust: 80, skill: 80 }
        },
        {
            id: "drug_baby", type: "drug",
            parent: {
                name: "å³å°å§", type: "æ¯’å“/å¦èªå‹",
                intro: "ä½ å€‘é†«é™¢å¾ˆå¥‡æ€ªæ¬¸ï¼Œå°å­©å°±è…¸çµç—›ä¸€ç›´å“­ï¼Œä½ å€‘å°±é€šå ±èªªæˆ‘å¸æ¯’ï¼Ÿ",
                r_incident: "æˆ‘æ²’æœ‰å¸æ¯’ï¼æˆ‘æ˜¯æ„Ÿå†’åƒè—¥ã€‚",
                r_deadlock: "è¬›äº†ä½ åˆä¸ä¿¡ï¼Œé‚£å¹¹å˜›å•æˆ‘ï¼Ÿ",
                r_child_deny: ["ä»–åœ¨ç¡è¦º..."],
                confront: "ï¼ˆçœ¼ç¥é–ƒçˆï¼‰å°±...æœ‹å‹ä¾†å®¶è£¡æŠ½è¸ï¼Œæˆ‘èåˆ°ä¸€é»äºŒæ‰‹è¸è€Œå·²å•¦ï¼",
                r_service_reject: "æˆ‘æ²’å¸æ¯’ä¸Šä»€éº¼æˆ’ç™®ï¼Ÿ",
                r_service_fake: "å¥½å•¦é©—å°±é©—ã€‚"
            },
            child: {
                name: "å°æ©", age: 0.2, // Infant
                medical_report: "æ–°ç”Ÿå…’æˆ’æ–·ç—‡ç‹€(NAS)ã€‚å°¿æ¶²æª¢æ¸¬é™½æ€§ã€‚",
                vuln: ["v1", "v2"]
            },
            p2_start: { trust: 10, skill: 0 }
        }
    ];

    // ==========================================
    // DATA: PHASE 2
    // ==========================================
    const P2_RESPONSES = {
        hostile: {
            visit: "æˆ‘æ²’ç©ºå•¦ï¼ä½ å€‘åˆä¸è®“æˆ‘å¸¶å›å®¶ï¼Œçœ‹äº†åªæœƒæ›´ç”Ÿæ°£ã€‚",
            resource: "æˆ‘å®¶æ²’å•é¡Œï¼Œä¸éœ€è¦ä½ å€‘é›å©†ã€‚",
            edu: "æˆ‘æ•™å°å­©é‚„è¦ä½ å€‘æ•™ï¼Ÿç¬‘è©±ã€‚",
            general: "ä¸è¦è·Ÿæˆ‘è¬›æ³•å¾‹ï¼Œæˆ‘ä¸åƒé€™ä¸€å¥—ï¼"
        },
        hardship: { 
            visit: "ç¤¾å·¥ï¼Œæˆ‘æœ€è¿‘å·¥å» åŠ ç­åˆ°åŠå¤œï¼ŒçœŸçš„æ²’è¾¦æ³•è«‹å‡...",
            resource: "å®¶è£¡çœŸçš„å¾ˆäº‚ï¼Œä½†æˆ‘èº«é«”ä¸èˆ’æœï¼Œæ²’åŠ›æ°£æ•´ç†...",
            edu: "æˆ‘ä¹Ÿæƒ³å»ä¸Šèª²ï¼Œä½†è€é—†èªªå†è«‹å‡å°±è¦é–‹é™¤æˆ‘äº†ã€‚",
            general: "å”‰...æˆ‘çœŸçš„ä¸çŸ¥é“è©²æ€éº¼è¾¦äº†ã€‚"
        },
        coop: {
            visit: "å¥½ï¼Œæˆ‘çŸ¥é“äº†ï¼Œæˆ‘æœƒæº–æ™‚åˆ°çš„ã€‚",
            resource: "è¬è¬ç¤¾å·¥å¹«å¿™ï¼Œé€™å€‹è£œåŠ©å°æˆ‘å€‘å¹«åŠ©å¾ˆå¤§ã€‚",
            edu: "ä¸Šæ¬¡è€å¸«æ•™çš„æ–¹æ³•æˆ‘æœ‰è©¦è‘—ç”¨ï¼Œå¥½åƒæœ‰é»ç”¨ã€‚",
            general: "æˆ‘æœƒåŠªåŠ›é…åˆï¼Œå¸Œæœ›èƒ½æ—©é»æ¥å­©å­å›ä¾†ã€‚"
        },
        lost: { general: "(è½‰æ¥èªéŸ³ä¿¡ç®±...)" }
    };

    const SW_OPTIONS = {
        strict: ["é€™æ˜¯æ³•é™¢çš„è£å®šï¼Œè«‹æ‚¨å‹™å¿…é…åˆã€‚", "ç¶“æ¿Ÿå›°é›£ä¸æ˜¯ç†ç”±ï¼Œé€™æ˜¯çˆ¶æ¯çš„è²¬ä»»ã€‚"],
        soft: ["æˆ‘ç†è§£æ‚¨çš„å›°é›£ã€‚æˆ‘å€‘è¨è«–ä¸€ä¸‹æ€éº¼è§£æ±ºï¼Ÿ", "è½èµ·ä¾†å£“åŠ›å¾ˆå¤§ï¼Œæˆ‘å€‘çœ‹çœ‹æœ‰æ²’æœ‰è³‡æºï¼Ÿ"],
        mistake: ["ä½ è‡ªå·±æ²’é¡§å¥½å°å­©æ‰è¢«å®‰ç½®ï¼Œæ€ªèª°ï¼Ÿ", "ä½ é€™æ¨£æ ¹æœ¬ä¸é…ç•¶çˆ¸çˆ¸ï¼"]
    };

    // ==========================================
    // STATE
    // ==========================================
    let state = {
        scenario: null,
        phase: 1,
        resistanceLevel: 2,
        childAccessStatus: 'pending',
        depthC: { verify: 0, care: 0, attach: 0 },
        childRevealedInfo: false,
        deadlockTriggered: false,
        counselingStatus: 'pending',
        clues: [],
        // P2
        month: 1, trust: 10, skill: 10, p2_mood: 'hostile', currentOptions: []
    };

    // ==========================================
    // INIT & UTILS
    // ==========================================
    window.onload = function() { 
        document.getElementById('controls-p1').innerHTML = `<button class="primary" onclick="p1_startIntro()" style="width:100%">ğŸ”” æŒ‰é–€éˆ´ä¸¦è‡ªæˆ‘ä»‹ç´¹</button>`;
        addMsg('p1', 'sys', 'èª¿æŸ¥æ¨¡æ“¬é–‹å§‹ã€‚');
        document.getElementById('info-name').innerText = "???";
        document.getElementById('info-parent').innerText = "???";
    };

    function addMsg(phase, type, text) {
        const container = document.getElementById(`chat-${phase}`);
        const div = document.createElement('div');
        div.className = `msg msg-${type}`;
        if(phase === 'p2' && type.includes('mood')) div.className = `msg msg-parent ${type}`;
        div.innerHTML = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addClue(text, type='neutral') {
        if(state.clues.includes(text)) return;
        state.clues.push(text);
        const div = document.createElement('div');
        div.className = `clue-entry ${type === 'alert' ? 'clue-alert' : (type === 'medical' ? 'clue-medical' : (type === 'positive' ? 'clue-positive' : ''))}`;
        div.innerText = text;
        document.getElementById('clue-log').appendChild(div);
    }

    // ==========================================
    // PHASE 1 LOGIC
    // ==========================================
    function p1_startIntro() {
        state.scenario = P1_SCENARIOS[Math.floor(Math.random() * P1_SCENARIOS.length)];
        
        document.getElementById('info-name').innerText = `${state.scenario.child.name} (${state.scenario.child.age}æ­²)`;
        document.getElementById('info-parent').innerText = `${state.scenario.parent.name} (${state.scenario.parent.type})`;
        
        if(state.scenario.id === 'hostile') state.resistanceLevel = 3;
        else if(state.scenario.id === 'low_risk') state.resistanceLevel = 0;
        else if(state.scenario.id === 'fake_compliance') state.resistanceLevel = 1;
        else state.resistanceLevel = 2;

        addMsg('p1', 'sw', 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯ç¤¾å·¥ã€‚æ”¶åˆ°é€šå ±é—œå¿ƒå­©å­ç‹€æ³ã€‚');
        setTimeout(() => {
            addMsg('p1', 'parent', state.scenario.parent.intro);
            let clueType = state.scenario.id === 'low_risk' ? 'positive' : 'status';
            addClue(`å®¶é•·åˆå§‹æ…‹åº¦ï¼š${state.scenario.parent.type}`, clueType);
            p1_renderControls();
        }, 800);
    }

    function p1_renderControls() {
        const c = document.getElementById('controls-p1');
        c.innerHTML = '';

        // 1. Deadlock Check
        if (state.deadlockTriggered) {
             c.innerHTML = `
                <div class="msg-danger">âš ï¸ æºé€šæ­»å±€ (Deadlock)</div>
                <div class="control-group">
                    <button class="btn-empathy" onclick="p1_tactic('soothe')">ğŸ§¡ å®‰æ’«åŒç†</button>
                    <button class="btn-clarify" onclick="p1_tactic('clarify')">ğŸ“¢ æ¾„æ¸…ç›®çš„</button>
                    <button class="btn-flank" onclick="p1_flank()">ğŸ”„ ç¹é“æˆ°è¡“ (å­¸æ ¡)</button>
                    <button class="deadlock-exit" onclick="openModal()">ğŸ›‘ ç„¡æ³•æºé€šï¼Œç›´æ¥è©•ä¼°</button>
                </div>`;
            return;
        }
        
        // 2. Service/Counseling Deadlock Check
        if (state.counselingStatus === 'deadlock') {
             c.innerHTML = `
                <div class="msg-danger">âš ï¸ å®¶é•·æ‹’çµ•é–‹æ¡ˆ</div>
                <div class="control-group"><button class="sup-btn" onclick="p1_consultSup()">ğŸ“ è«®è©¢ç£å°</button></div>`;
             return;
        }

        let html = `<div class="control-group">`;

        // 3. Main Options
        html += `<button onclick="p1_ask('incident')">ğŸ¤• è©¢å•å‚·å‹¢</button>`;

        // Child Access
        if (state.scenario.child.age < 2) {
            // Infant -> Medical Report
            html += `<button class="medical" onclick="p1_checkMedical()">ğŸ¥ æª¢è¦–é†«ç™‚å ±å‘Š</button>`;
        } else {
            // Older Child -> Interview
            if (state.childAccessStatus === 'pending') {
                html += `<button onclick="p1_reqChild()">ğŸ‘¶ è¦æ±‚æ¥è§¸å°å­©</button>`;
            } else if (state.childAccessStatus === 'blocked') {
                 html += `</div><div class="msg-sys">å®¶é•·æ‹’çµ•ã€‚</div><div class="control-group">`;
                 html += `<button class="btn-soft" onclick="p1_reqChild_2('soft')">ğŸ™ æŸ”æ€§å‹¸èªª</button>`;
                 html += `<button class="btn-hard" onclick="p1_reqChild_2('hard')">âš–ï¸ å¼·ç¡¬æ³•è¦</button>`;
            } else if (state.childAccessStatus === 'granted') {
                 html += `</div><div class="group-label">å…’å°‘è¨ªè«‡</div><div class="control-group">`;
                 if(state.depthC.verify === 0) html += `<button class="child-btn" onclick="p1_askC('verify')">â“ æ ¸å¯¦å‚·å‹¢</button>`;
                 if(state.depthC.care === 0) html += `<button class="child-btn" onclick="p1_askC('care')">ğŸ² ç¢ºèªç…§é¡§</button>`;
                 if(state.depthC.attach === 0) html += `<button class="child-btn" onclick="p1_askC('attach')">ğŸ‘€ è§€å¯Ÿä¾é™„</button>`;
            }
        }

        // Confrontation (Unlock)
        if (state.childRevealedInfo) {
             html += `<button class="confront" onclick="p1_confront()">âš ï¸ èˆ‡å®¶é•·å°è³ª</button>`;
        }

        html += `</div>`;

        // 3. Open Case / Education (Final Step Button)
        if (state.counselingStatus === 'pending') {
            html += `<div class="control-group" style="margin-top:20px;">
                <button class="service-btn" onclick="p1_discussServices()">ğŸ—£ï¸ èªªæ˜é–‹æ¡ˆ/è¦ªè·æ•™è‚² (ä¸¦çµæŸè¨ªè«‡)</button>
            </div>`;
        }

        c.innerHTML = html;
    }

    // --- P1 Actions ---
    function p1_ask(type) {
        addMsg('p1', 'sw', 'å¯ä»¥èªªæ˜ä¸€ä¸‹ç‹€æ³å—ï¼Ÿ');
        setTimeout(() => {
            if(state.resistanceLevel >= 3) {
                state.deadlockTriggered = true;
                addMsg('p1', 'parent', state.scenario.parent.r_deadlock);
                addClue("å®¶é•·æƒ…ç·’å‹’ç´¢æ‹’çµ•æºé€š", "alert");
            } else {
                addMsg('p1', 'parent', state.scenario.parent.r_incident);
                if(state.scenario.id !== 'low_risk') addClue("å®¶é•·è§£é‡‹å«ç³Š");
            }
            p1_renderControls();
        }, 800);
    }

    function p1_tactic(type) {
        if (type === 'soothe') {
             addMsg('p1', 'sw', 'çˆ¸çˆ¸å…ˆæ¶ˆæ¶ˆæ°£ï¼Œæˆ‘å€‘ä¸æ˜¯è¦ä¾†æŒ‡è²¬ä½ ã€‚');
             state.resistanceLevel = 1;
             addMsg('p1', 'sys', 'å®¶é•·é˜²è¡›é™ä½ã€‚');
        } else if (type === 'clarify') {
             addMsg('p1', 'sw', 'å®‰ç½®æ˜¯æœ€å¾Œæ‰‹æ®µï¼Œæˆ‘å€‘ç›®çš„æ˜¯å”åŠ©ç•™å®¶ã€‚');
             state.resistanceLevel = 1;
        } else if (type === 'flank') {
             p1_flank();
             return;
        }
        state.deadlockTriggered = false;
        setTimeout(() => { addMsg('p1', 'parent', "å”‰...å¥½å•¦ã€‚"); p1_renderControls(); }, 1000);
    }

    function p1_flank() {
        addMsg('p1', 'sw', 'é‚£æˆ‘æ”¹å¤©å†ä¾†ã€‚');
        addMsg('p1', 'sys', 'å ´æ™¯è½‰æ›ï¼šå‰å¾€å­¸æ ¡è¨ªè¦–...');
        state.childAccessStatus = 'granted';
        state.deadlockTriggered = false;
        p1_askC('verify');
    }

    function p1_reqChild() {
        addMsg('p1', 'sw', 'æˆ‘éœ€è¦ç¢ºèªå­©å­å®‰å…¨ã€‚');
        setTimeout(() => {
            let denyText = state.scenario.parent.r_child_deny[0];
            if(state.resistanceLevel >= 2) {
                addMsg('p1', 'parent', denyText);
                addClue("å®¶é•·é˜»æ“‹æ¥è§¸", "alert");
                state.childAccessStatus = 'blocked';
            } else {
                addMsg('p1', 'parent', "å¥½å•¦åœ¨æˆ¿é–“ã€‚");
                state.childAccessStatus = 'granted';
            }
            p1_renderControls();
        }, 800);
    }

    function p1_reqChild_2(strat) {
        addMsg('p1', 'sw', strat === 'soft' ? 'æˆ‘å€‘çœ‹ä¸€çœ¼å°±å¥½ï¼Œå¹¾åˆ†é˜ã€‚' : 'ä¾å…’å°‘æ¬Šæ³•æˆ‘æœ‰æ¬Šè¨ªè¦–ï¼Œè«‹é…åˆã€‚');
        setTimeout(() => {
            if(Math.random() > 0.5) {
                addMsg('p1', 'parent', "å¥½å•¦ç…©æ­»äº†ã€‚");
                state.childAccessStatus = 'granted';
            } else {
                addMsg('p1', 'parent', "ä¸è¡Œå°±æ˜¯ä¸è¡Œï¼");
                state.deadlockTriggered = true; 
            }
            p1_renderControls();
        }, 800);
    }

    function p1_askC(topic) {
        let questions = {
            verify: "ç—›ç—›æ€éº¼å¼„çš„ï¼Ÿ",
            care: "å¹³å¸¸åƒä»€éº¼ï¼Ÿæœ‰æ™‚å€™æœƒæ²’é£¯åƒå—ï¼Ÿ",
            attach: "(è§€å¯Ÿäº’å‹•)"
        };
        addMsg('p1', 'sw', questions[topic]);
        
        setTimeout(() => {
            let childData = state.scenario.child.r;
            let resp = "";
            let clue = "";
            let type = "child";

            if(topic === 'verify') {
                resp = childData.verify;
                if(state.scenario.id === 'low_risk') {
                    clue = "å…’å°‘è¡¨ç¤ºæ„å¤–å—å‚·(ä¸€è‡´)";
                    type = "positive";
                } else {
                    clue = "å…’å°‘é€éœ²å—æš´äº‹å¯¦";
                    type = "alert";
                    state.childRevealedInfo = true;
                    document.getElementById('d1').checked = true;
                }
                state.depthC.verify = 1;
            } else if (topic === 'care') {
                resp = childData.care;
                if(state.scenario.id === 'low_risk') {
                    clue = "å…’å°‘è¡¨ç¤ºå—å¦¥é©ç…§é¡§";
                    type = "positive";
                } else if (state.scenario.id === 'fake_compliance') {
                    clue = "å…’å°‘é€éœ²ç–å¿½/å“è³ªä¸ä½³"; 
                    type = "alert";
                    document.getElementById('d3').checked = true;
                } else {
                    clue = "å…’å°‘é€éœ²åš´é‡ç–å¿½/æŒ¨é¤“";
                    type = "alert";
                    document.getElementById('d3').checked = true;
                }
                state.depthC.care = 1;
            } else if (topic === 'attach') {
                resp = childData.attach;
                if(state.scenario.id === 'low_risk') {
                    clue = "ä¾é™„é—œä¿‚å®‰å…¨";
                    type = "positive";
                    document.getElementById('p6').checked = true;
                } else {
                    clue = "ä¾é™„é—œä¿‚ä¸ä½³/ææ‡¼";
                    type = "alert";
                }
                state.depthC.attach = 1;
            }
            
            addMsg('p1', 'child', resp);
            addClue(clue, type);
            p1_renderControls();
        }, 800);
    }

    function p1_checkMedical() {
        addMsg('p1', 'sw', 'ï¼ˆæª¢è¦–å ±å‘Š...ï¼‰');
        setTimeout(() => {
            addMsg('p1', 'doc', `è¨ºæ–·ï¼š${state.scenario.child.medical_report}`);
            addClue(`é†«ç™‚è¨ºæ–·ï¼š${state.scenario.child.medical_report}`, "medical");
            state.childRevealedInfo = true;
            if(state.scenario.type === 'drug') document.getElementById('d3').checked = true;
            if(state.scenario.type === 'abuse') document.getElementById('d1').checked = true;
            p1_renderControls();
        }, 1000);
    }

    function p1_confront() {
        addMsg('p1', 'sw', 'è­‰æ“šé¡¯ç¤ºé€™æ˜¯å¤–åŠ›é€ æˆçš„ï¼Œè«‹æ‚¨è§£é‡‹ï¼');
        setTimeout(() => {
            addMsg('p1', 'parent', state.scenario.parent.confront);
            addClue(`å°è³ªåæ‡‰ï¼š${state.scenario.parent.confront}`, "alert");
            document.getElementById('d8').checked = true;
            p1_renderControls();
        }, 1000);
    }

    function p1_discussServices() {
        addMsg('p1', 'sw', 'æˆ‘å€‘éœ€è¦é–‹æ¡ˆä¸¦å®‰æ’è¦ªè·æ•™è‚²ã€‚');
        setTimeout(() => {
            if(state.resistanceLevel >= 2) {
                addMsg('p1', 'parent', state.scenario.parent.r_service_reject);
                state.counselingStatus = 'deadlock';
            } else {
                addMsg('p1', 'parent', state.scenario.parent.r_service_fake);
                state.counselingStatus = 'resolved';
                // Directly open modal after success
                openModal();
            }
            p1_renderControls();
        }, 1000);
    }

    function p1_consultSup() {
        addMsg('p1', 'sw', 'ç£å°ï¼Œå®¶é•·å¼·çƒˆæŠ—æ‹’ã€‚');
        setTimeout(() => {
            if(Math.random() > 0.5) {
                addMsg('p1', 'sup', 'ç£å°ï¼šå…ˆæ”¹ç”¨è³‡æºåª’åˆåˆ‡å…¥ã€‚');
                addClue("ç£å°å»ºè­°ï¼šè³‡æºåª’åˆ", "status");
            } else {
                addMsg('p1', 'sup', 'ç£å°ï¼šå»å¼·èª¿æ³•å¾‹å¾Œæœã€‚');
                addClue("ç£å°æŒ‡ç¤ºï¼šå¼·èª¿æ³•è¦", "status");
            }
            state.counselingStatus = 'resolved';
            p1_renderControls();
        }, 1000);
    }

    // ==========================================
    // TRANSITION
    // ==========================================
    function openModal() { document.getElementById('assessment-modal').style.display = 'block'; }
    function submitDecision() {
        document.getElementById('assessment-modal').style.display = 'none';
        if(state.scenario.id === 'low_risk') {
            alert("ã€è£å®šï¼šç„¡é ˆé–‹æ¡ˆ/çµæ¡ˆã€‘\nè©•ä¼°ç‚ºä½é¢¨éšªæ¡ˆä»¶ï¼Œæ”¯æŒç³»çµ±å……è¶³ã€‚");
            location.reload();
        } else {
            alert("ã€è£å®šï¼šç·Šæ€¥å®‰ç½®ã€‘\né€²å…¥å®‰ç½®è™•é‡éšæ®µ (Phase 2)");
            initPhase2();
        }
    }

    // ==========================================
    // PHASE 2: PLACEMENT
    // ==========================================
    function initPhase2() {
        document.getElementById('view-phase1').classList.remove('active-view');
        document.getElementById('view-phase2').classList.add('active-view');
        document.getElementById('p1-sidebar').style.display = 'none';
        document.getElementById('p2-sidebar').style.display = 'block';
        state.p2_mood = state.resistanceLevel >= 2 ? 'hostile' : 'hardship';
        p2_updateStats();
        p2_renderActions();
        addMsg('p2', 'sys', 'å®‰ç½®åˆæœŸã€‚');
    }

    function p2_updateStats() {
        document.getElementById('txt-trust').innerText = state.trust + '%';
        document.getElementById('bar-trust').style.width = state.trust + '%';
        document.getElementById('txt-skill').innerText = state.skill + '%';
        document.getElementById('bar-skill').style.width = state.skill + '%';
        document.getElementById('txt-month').innerText = `Month ${state.month}/12`;
        let moodLabel = { hostile: "æ•µæ„", hardship: "å›°é›£/ç„¡åŠ›", coop: "é…åˆ", lost: "å¤±è¯" };
        document.getElementById('p2-mood-status').innerText = `å®¶é•·ç•¶å‰ç‹€æ…‹: ${moodLabel[state.p2_mood]}`;
    }

    function p2_renderActions() {
        const c = document.getElementById('controls-p2');
        c.innerHTML = `
            <div class="action-grid">
                <button onclick="p2_act('visit')"><span>ğŸ—£ï¸ æœƒé¢å®‰æ’</span><small>è¯ç¹«æ¢è¦–</small></button>
                <button onclick="p2_act('resource')"><span>ğŸ  è³‡æºé€£çµ</span><small>å”åŠ©ç’°å¢ƒ</small></button>
                <button onclick="p2_act('edu')"><span>ğŸ“š è¦ªè·æ•™è‚²</span><small>ç£ä¿ƒèª²ç¨‹</small></button>
                <button onclick="p2_act('law')"><span>âš–ï¸ æ³•å¾‹èªªæ˜</span><small>æ¾„æ¸…è¦ç¯„</small></button>
            </div>
        `;
    }

    function p2_act(action) {
        let mood = state.p2_mood;
        let responses = P2_RESPONSES[mood];
        let txt = responses[action] || responses.general;
        if (Array.isArray(responses)) txt = responses[Math.floor(Math.random()*responses.length)];
        else txt = responses[action] || responses.general;

        addMsg('p2', `parent mood-${mood}`, `<strong>å®¶é•·ï¼š</strong><br>${txt}`);
        p2_genOptions();
    }

    function p2_genOptions() {
        const c = document.getElementById('controls-p2');
        let opts = [
            { text: SW_OPTIONS.strict[0], dT: -5, dS: +5 },
            { text: SW_OPTIONS.soft[0], dT: +5, dS: +5 },
            { text: SW_OPTIONS.mistake[0], dT: -15, dS: -5 }
        ];
        opts.sort(()=>Math.random()-0.5);
        state.currentOptions = opts;
        let html = opts.map((o,i) => `<button class="btn-dialogue" onclick="p2_handle(${i})"><strong>(ç¤¾å·¥)</strong> "${o.text}"</button>`).join('');
        c.innerHTML = `<div class="response-grid">${html}</div>`;
    }

    function p2_handle(i) {
        let o = state.currentOptions[i];
        addMsg('p2', 'sw', `<strong>æˆ‘ï¼š</strong><br>${o.text}`);
        state.trust += o.dT; state.skill += o.dS;
        
        // Mood Shift
        if(state.trust > 50 && state.p2_mood === 'hostile') state.p2_mood = 'hardship';
        else if(state.trust > 70 && state.p2_mood === 'hardship') state.p2_mood = 'coop';
        
        p2_next();
    }

    function p2_next() {
        state.month++;
        if(state.month > 12) {
            let res = (state.skill > 60 && state.trust > 50) ? "æ¼¸é€²å¼è¿”å®¶" : "åœæ­¢è¦ªæ¬Š";
            addMsg('p2', 'sys', `è©•ä¼°çµæŸã€‚çµæœï¼š${res}`);
            document.getElementById('controls-p2').innerHTML = `<button class="primary" onclick="location.reload()">ğŸ”„ é‡ç½®</button>`;
        } else {
            p2_updateStats();
            addMsg('p2', 'sys', `--- ç¬¬ ${state.month} å€‹æœˆ ---`);
            p2_renderActions();
        }
    }
</script>
</body>
</html>