<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ˆè­·é˜²ç·šï¼šå…’å°‘ä¿è­·å…¨æ­·ç¨‹çµ‚æ¥µç‰ˆ</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --panel-bg: #2c2c2c;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-blue: #64b5f6;
            --accent-green: #81c784;
            --accent-yellow: #fff176;
            --accent-red: #ef5350;
            --accent-purple: #ce93d8;
            --accent-orange: #ffb74d;
            --border-color: #424242;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 340px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-title { font-size: 1.1rem; color: var(--accent-blue); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .clue-log { font-size: 0.9rem; color: var(--text-muted); flex: 1; }
        .clue-entry { margin-bottom: 10px; padding-left: 10px; border-left: 2px solid var(--accent-yellow); line-height: 1.4; animation: fadeIn 0.5s; }
        .clue-alert { border-left-color: var(--accent-red); color: #ffcdd2; font-weight: bold; }

        /* Stats Bar */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; margin-top: 15px;}
        .progress-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .chat-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Messages */
        .msg { max-width: 85%; padding: 15px; border-radius: 10px; line-height: 1.6; animation: fadeIn 0.3s ease; position: relative; }
        .msg-sw { align-self: flex-end; background-color: #1565c0; color: white; border-right: 4px solid #90caf9; text-align: right; }
        .msg-parent { align-self: flex-start; background-color: #424242; border-left: 4px solid var(--accent-yellow); }
        .msg-child { align-self: flex-start; background-color: #2e7d32; border-left: 4px solid var(--accent-green); }
        .msg-sup { align-self: flex-start; background-color: #37474f; border-left: 4px solid var(--accent-orange); color: #eceff1; } /* Supervisor */
        .msg-sys { align-self: center; background: rgba(255,255,255,0.05); color: #aaa; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; margin: 10px 0; text-align: center;}
        
        .msg-danger { 
            align-self: center; 
            background-color: rgba(239, 83, 80, 0.2); 
            border: 2px solid var(--accent-red); 
            color: #ffcdd2; 
            font-weight: bold;
            text-align: center;
            width: 90%;
        }

        /* Controls */
        #controls {
            padding: 20px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            min-height: 160px;
        }
        .control-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; align-items: center; }
        
        button {
            padding: 12px 20px;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            min-width: 140px;
            text-align: left;
            display: flex; flex-direction: column; justify-content: center;
        }
        button:hover { background-color: #555; border-color: var(--accent-blue); transform: translateY(-2px); }
        button small { font-size: 0.8rem; color: #aaa; margin-top: 2px; }
        
        button.primary { background-color: #1565c0; border-color: #1565c0; font-weight: bold; text-align: center; align-items: center;}
        button.highlight { border: 1px solid var(--accent-yellow); color: var(--accent-yellow); }
        
        /* Strategy Buttons Phase 1 */
        .btn-soft { border-left: 4px solid var(--accent-green); }
        .btn-hard { border-left: 4px solid var(--accent-red); }
        .btn-fallback { border-left: 4px solid var(--accent-purple); }
        .btn-retreat { border-left: 5px solid var(--accent-green); background: rgba(76, 175, 80, 0.1); }
        .btn-risk { border-left: 5px solid var(--accent-red); background: rgba(244, 67, 54, 0.1); }

        /* Dialogue Buttons Phase 2 */
        .btn-dialogue { min-height: 80px; width: 48%; background-color: #2a2a2a; border: 1px solid #444; align-items: flex-start; }
        .response-grid { display: flex; gap: 10px; justify-content: space-between; width: 100%; }
        .sup-btn { border-left: 5px solid var(--accent-orange); background: rgba(255, 183, 77, 0.1); width: 100%; align-items: center;}

        /* Modal */
        #assessment-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; padding: 40px; box-sizing: border-box; overflow-y: auto;}
        .form-card { background: var(--card-bg); max-width: 900px; margin: 0 auto; padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); }
        label { display: flex; margin-bottom: 8px; cursor: pointer; line-height: 1.5;}
        input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); accent-color: var(--accent-green); flex-shrink: 0; margin-top: 4px;}
        h3 { color: var(--accent-blue); border-bottom: 1px dashed #444; padding-bottom: 5px; margin-top: 20px;}

        #view-phase1, #view-phase2 { display: none; height: 100%; flex-direction: column; }
        .active-view { display: flex !important; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<aside>
    <div class="sidebar-title">ğŸ“ å€‹æ¡ˆç‹€æ…‹</div>
    <div style="margin-bottom: 20px;">
        <strong>å…’å°‘ï¼š</strong><span id="info-name">å°å®‰ (7æ­²)</span><br>
        <strong>ç…§é¡§è€…ï¼š</strong><span id="info-parent">æå…ˆç”Ÿ</span>
    </div>
    
    <div id="p1-sidebar">
        <div class="sidebar-title">èª¿æŸ¥ç­†è¨˜</div>
        <div id="clue-log" class="clue-log"></div>
    </div>

    <div id="p2-sidebar" style="display:none; border-top:1px solid #444; padding-top:20px;">
        <div class="sidebar-title">å®‰ç½®è™•é‡æŒ‡æ¨™</div>
        <div class="stat-row"><span>ğŸ¤ ä¿¡ä»»é—œä¿‚</span><span id="txt-trust">20%</span></div>
        <div class="progress-bg"><div id="bar-trust" class="progress-fill" style="width:20%; background:var(--accent-green);"></div></div>
        <div class="stat-row"><span>ğŸ“š è¦ªè·èƒ½åŠ›</span><span id="txt-skill">10%</span></div>
        <div class="progress-bg"><div id="bar-skill" class="progress-fill" style="width:10%; background:var(--accent-blue);"></div></div>
        <div class="stat-row"><span>ğŸ“… é€²åº¦</span><span id="txt-month">Month 1/12</span></div>
    </div>
</aside>

<main>
    <div id="view-phase1" class="active-view">
        <div id="chat-p1" class="chat-container"></div>
        <div id="controls-p1" id="controls"></div>
    </div>

    <div id="view-phase2">
        <div style="padding: 10px 30px; background: #111; border-bottom: 1px solid #333; text-align: center; font-weight: bold; color: var(--accent-blue);">
            å®‰ç½®è™•é‡éšæ®µ (Placement Phase)
        </div>
        <div id="chat-p2" class="chat-container"></div>
        <div id="controls-p2" id="controls"></div>
    </div>
</main>

<div id="assessment-modal">
    <div class="form-card">
        <h2 style="color:var(--accent-blue); margin-top:0;">ğŸ“‹ å…’å°‘å®‰å…¨è©•ä¼°è¡¨ (SDM)</h2>
        <form id="sdm-form">
            <h3>A. ç„¡åŠ©ç‹€æ…‹ (Vulnerability)</h3>
            <label><input type="checkbox" id="v1"> 1. 6è¶³æ­²ä»¥ä¸‹</label>
            <label><input type="checkbox" id="v2"> 2. è¢«è¨ºæ–·æˆ–é‘‘å®šå‡ºæœ‰ç”Ÿç†æˆ–å¿ƒç†ç—…ç—‡</label>
            <label><input type="checkbox" id="v3"> 3. åš´é‡çš„è¡Œç‚ºåŠæƒ…ç·’æˆ–å¿ƒç†å•é¡Œ</label>
            <label><input type="checkbox" id="v4"> 4. å—é™çš„ç™¼å±•åŠèªçŸ¥èƒ½åŠ›(ä¾‹å¦‚ï¼šç™¼å±•é²ç·©ã€èªè¨€æå‚·)</label>
            <label><input type="checkbox" id="v5"> 5. å—é™çš„èº«é«”èƒ½åŠ›(ä¾‹å¦‚ï¼šå—æçš„ç§»å‹•èƒ½åŠ›ã€èº«é«”éšœç¤™)</label>
            <label><input type="checkbox" id="v6"> 6. èˆ‡ç¤¾å€éš”é›¢ï¼Œæˆ–å’Œå…¶ä»–æˆäººã€è¦ªå‹çš„æ¥è§¸æœ‰é™</label>

            <h3>B. å±éšªå› ç´  (Danger Factors)</h3>
            <label><input type="checkbox" id="d1"> 1. ç…§é¡§è€…æˆ–å®¶æˆ¶ä¸­æˆäººå°å…’å°‘é€ æˆåš´é‡çš„èº«é«”å‚·å®³ï¼Œæˆ–æ˜¯å°‡å°ä»–å€‘é€ æˆèº«é«”å‚·å®³</label>
            <label><input type="checkbox" id="d2"> 2. ç…§é¡§è€…å°å…’å°‘æ€§ä¾µå®³ï¼Œæˆ–æœ‰ç…§é¡§è€…è¢«æ‡·ç–‘å°å…’å°‘æ€§ä¾µå®³ã€‚</label>
            <label><input type="checkbox" id="d3"> 3. ç…§é¡§è€…æ²’æœ‰æ»¿è¶³å…’å°‘çš„åŸºæœ¬éœ€æ±‚ï¼Œä»¥è‡´å°å…’å°‘å·²é€ æˆï¼ˆæˆ–å¯èƒ½é€ æˆï¼‰åš´é‡çš„å‚·å®³ã€‚</label>
            <label><input type="checkbox" id="d4"> 4. å±…ä½æ¢ä»¶ä¸ä½³ï¼Œä¸”å°æ–¼å…’å°‘çš„å¥åº·åŠå®‰å…¨æœ‰ç«‹å³çš„å¨è„…ã€‚</label>
            <label><input type="checkbox" id="d5"> 5. ç…§é¡§è€…çš„è¡Œç‚ºå¾ˆå¯èƒ½é€ æˆå…’å°‘åš´é‡çš„å¿ƒç†å‰µå‚·ï¼Œä¸”å…’å°‘å·²è¢«è§€å¯Ÿåˆ°æœ‰åš´é‡çš„å¿ƒç†æˆ–æƒ…ç·’å‰µå‚·ã€‚</label>
            <label><input type="checkbox" id="d6"> 6. ç•¶å…’å°‘é­å—åˆ°ä»–äººåš´é‡å‚·å®³æˆ–å¯èƒ½é­å—ä»–äººåš´é‡å‚·å®³æ™‚ï¼Œç…§é¡§è€…æ²’æœ‰æä¾›é©åˆ‡çš„ä¿è­·ã€‚</label>
            <label><input type="checkbox" id="d7"> 7. æ¡ˆå®¶ä¸æä¾›è®“ç¤¾å·¥èˆ‡å…’å°‘æ¥è§¸çš„ç®¡é“ï¼Œé˜»ç¤™æˆ–é€ƒé¿èª¿æŸ¥çš„é€²è¡Œï¼Œæˆ–æ˜¯æœ‰å…¶ä»–ç†ç”±èªç‚ºæ¡ˆå®¶æœ‰æ¬é›¢çš„æ‰“ç®—ã€‚</label>
            <label><input type="checkbox" id="d8"> 8. ç…§é¡§è€…å°æ–¼å…’å°‘èº«ä¸Šçš„å‚·å®³ç„¡æ³•æå‡ºåˆç†çš„è§£é‡‹ï¼Œæˆ–å°æ–¼æ˜¯å“ªä¸€ç¨®é¡å‹çš„å‚·å®³ï¼Œä»¥åŠå‚·å®³å¦‚ä½•å½¢æˆå‰å¾Œå›ç­”ä¸ä¸€è‡´ï¼Œè¡¨ç¤ºå…’å°‘å¯èƒ½è™•åœ¨ç«‹å³çš„å±éšªç•¶ä¸­ã€‚</label>

            <h3>C. å®‰å…¨è¨ˆç•« (Safety Plan)</h3>
            <p style="color:var(--accent-yellow); font-size:0.9rem;">*è‹¥æœ‰å±éšªå› å­ï¼Œä¸”ä¿è­·å› å­3,4,7,8æœªå…¨æ•¸ç¬¦åˆï¼Œå¿…é ˆè€ƒé‡ç·Šæ€¥å®‰ç½®ã€‚</p>
            <label><input type="checkbox" id="p1"> 1. ç…§é¡§è€…çš„è¡Œå‹•ç›´æ¥æ¸›è¼•ç¾å­˜å±éšªå› ç´ çš„å¨è„…ï¼Œåªæ˜¯å°šæœªè­‰æ˜å¯é•·æ™‚é–“å±•ç¾ã€‚</label>
            <label><input type="checkbox" id="p2"> 2. ç…§é¡§è€…åœ¨æ­¤æ¬¡é€šå ±äº‹ä»¶å‰æ›¾æ¡å–è¡Œå‹•ç¢ºä¿å…’å°‘å…æ–¼é¡ä¼¼çš„å±éšªã€‚</label>
            <label><input type="checkbox" id="p3" class="critical"> 3. ç…§é¡§è€…å…·æœ‰èªçŸ¥ã€ç”Ÿç†ã€æƒ…ç·’ä¸Šçš„èƒ½åŠ›å¯åƒèˆ‡å®‰å…¨ç¶­è­·è¡Œå‹•ã€‚</label>
            <label><input type="checkbox" id="p4" class="critical"> 4. ç…§é¡§è€…äº†è§£ä¸¦æ¥å—å±éšªã€‚</label>
            <label><input type="checkbox" id="p5"> 5. ç…§é¡§è€…è­‰æ˜éå»æœ‰èƒ½åŠ›æ»¿è¶³å…’å°‘çš„èº«å¿ƒéœ€æ±‚ï¼Œä¸”æ‰¿è«¾æœªä¾†å°‡ç¹¼çºŒç¶­è­·å…¶èº«å¿ƒå¥å…¨ã€‚</label>
            <label><input type="checkbox" id="p6"> 6. æœ‰äº‹å¯¦é¡¯ç¤ºç…§é¡§è€…èˆ‡å…’å°‘æœ‰å¥åº·è€Œè‰¯å¥½çš„é—œä¿‚ã€‚</label>
            <label><input type="checkbox" id="p7" class="critical"> 7. ç…§é¡§è€…é¡˜æ„ä¸”èƒ½å¤ æ¥å—å®‰å…¨ç¶²çµ¡æˆå“¡çš„å”åŠ©ã€‚</label>
            <label><input type="checkbox" id="p8" class="critical"> 8. è‡³å°‘æœ‰ä¸€ä½å®‰å…¨ç¶²çµ¡æˆå“¡åƒèˆ‡å®‰å…¨è¨ˆç•«ã€‚</label>
        </form>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="document.getElementById('assessment-modal').style.display='none'" style="flex:1">è¿”å›èª¿æŸ¥</button>
            <button class="primary" onclick="submitDecision()" style="flex:2">æäº¤è©•ä¼°ä¸¦è£å®š</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // DATA
    // ==========================================
    const P1_DATA = {
        parent: {
            intro: "é€™æ¨£éš¨ä¾¿ä¸€å€‹äººé€šå ±å°±è¦ä¾†èª¿æŸ¥æˆ‘ï¼Ÿä½ å€‘åƒé£½å¤ªé–’å—ï¼Ÿ",
            r_incident_0: "å°å­©å°±è‡ªå·±å—å‚·çš„è¬›äº†ä½ åˆä¸ä¿¡ï¼",
            r_incident_1: "ä¸ç„¶ä½ å²å®³ä½ å€‘æœƒæ•™ä½ å€‘å¸¶èµ°å•Šï¼çœ‹ä½ å€‘å¤šæœƒæ•™ï¼",
            r_attack: "ï¼ˆçªç„¶ç«™èµ·ï¼ŒæŠ„èµ·æ—é‚Šçš„é…’ç“¶ï¼‰ä½ å†ä¸æ»¾å‡ºå»è©¦è©¦çœ‹ï¼", // æ”»æ“Š
            r_child_deny_1: "ä»–åœ¨ç¡è¦ºï¼ä¸å‡†é€²å»ï¼",
            r_child_deny_2: "æˆ‘èªªä¸è¡Œå°±æ˜¯ä¸è¡Œï¼é€™æ˜¯æˆ‘çš„å®¶ï¼Œæˆ‘æœ‰æ¬Šåˆ©æ‹’çµ•ï¼",
            r_school_mode: "æˆ‘å€‘æ˜¯é‚£ç¨®æ­£å¸¸å®¶åº­ï¼Œä¸æ˜¯ä½ å€‘æ‡·ç–‘çš„ä¸å¥½çš„å®¶é•·ã€‚",
            r_supervised: "å¥½å•¦ï¼ç…©æ­»äº†ï¼Œæˆ‘åœ¨æ—é‚Šçœ‹è‘—ï¼Œä½ å€‘å¿«é»å•ä¸€å•æ»¾è›‹ã€‚",
            r_reluctant: "ï¼ˆæ†¤æ€’åœ°ç”©é–€ï¼‰è¦çœ‹å°±å»çœ‹å•¦ï¼"
        },
        child: {
            verify: "æ˜¯çˆ¸çˆ¸æ‰“çš„...ä»–å–é†‰å°±å¾ˆå…‡...",
            supervised_verify: "ï¼ˆå·ç„çˆ¸çˆ¸ï¼‰...æ˜¯æˆ‘è‡ªå·±è·Œå€’çš„..."
        }
    };

    const P2_DATA = {
        hostile: [
            "çœ‹ä»€éº¼çœ‹ï¼Ÿå°å­©éƒ½è¢«ä½ å€‘æ¶èµ°äº†ï¼æˆ‘ä¸æƒ³è·Ÿä½ å€‘è¬›è©±ï¼",
            "ä¸ç„¶ä½ å²å®³ä½ å€‘æœƒæ•™ä½ å€‘å¸¶èµ°å•Šï¼åæ­£æˆ‘å°±æ˜¯çˆ›å®¶é•·ï¼",
            "ä¸è¦è·Ÿæˆ‘è¬›æ³•å¾‹ï¼Œæˆ‘ä¸åƒé€™ä¸€å¥—ï¼ä½ å€‘å°±æ˜¯æ¬ºè² çª®äººï¼"
        ],
        complaint: [ // æŠ•è¨´èˆ‡è¢«å‘Š
            "æˆ‘æ²’æœ‰è¾¦æ³•è·Ÿä½ é€™å€‹äººæºé€šæ¬¸ï¼Œä¸èƒ½æ›ç¤¾å·¥å—ï¼Ÿæˆ‘è¦å»æŠ•è¨´ä½ ï¼",
            "æˆ‘è¦å‘Šä½ å€‘ç¶æ¶ï¼æˆ‘å·²ç¶“æ‰¾è­°å“¡äº†ï¼Œä½ å€‘ç­‰è‘—æ”¶å‚³ç¥¨ï¼"
        ],
        hardship: [
            "ç¤¾å·¥ï¼Œæˆ‘æœ€è¿‘å·¥å» åŠ ç­åˆ°åŠå¤œï¼ŒçœŸçš„æ²’è¾¦æ³•è«‹å‡...",
            "æˆ‘èº«é«”å¾ˆä¸èˆ’æœï¼Œæ²’å¿ƒæƒ…è«‡é€™äº›ï¼Œæ”¹å¤©å¥½ä¸å¥½ï¼Ÿ"
        ],
        coop: [
            "å¥½ï¼Œæˆ‘æœƒæº–æ™‚åˆ°çš„ã€‚",
            "è¬è¬ç¤¾å·¥å¹«å¿™ï¼Œæˆ‘æœƒåŠªåŠ›æŠŠå®¶è£¡å¼„å¥½ã€‚"
        ],
        lost: [
            "(é›»è©±è½‰æ¥èªéŸ³ä¿¡ç®±...)", "(Lineè¨Šæ¯å·²è®€ä¸å›...)"
        ]
    };

    const SW_OPTIONS = {
        strict: ["é€™æ˜¯æ³•é™¢çš„è£å®šï¼Œè«‹æ‚¨å‹™å¿…é…åˆã€‚", "ç¶“æ¿Ÿå›°é›£ä¸æ˜¯ç†ç”±ï¼Œé€™æ˜¯çˆ¶æ¯çš„è²¬ä»»ã€‚"],
        soft: ["æˆ‘ç†è§£æ‚¨çš„å›°é›£ã€‚æˆ‘å€‘è¨è«–ä¸€ä¸‹æ€éº¼è§£æ±ºï¼Ÿ", "è½èµ·ä¾†å£“åŠ›å¾ˆå¤§ï¼Œæˆ‘å€‘çœ‹çœ‹æœ‰æ²’æœ‰è³‡æºï¼Ÿ"],
        mistake: ["ä½ è‡ªå·±æ²’é¡§å¥½å°å­©æ‰è¢«å®‰ç½®ï¼Œæ€ªèª°ï¼Ÿ", "ä½ é€™æ¨£æ ¹æœ¬ä¸é…ç•¶çˆ¸çˆ¸ï¼"]
    };

    // ==========================================
    // STATE
    // ==========================================
    let state = {
        phase: 1,
        depthP: { incident: 0 },
        childAccessStatus: 'pending',
        escalationTriggered: false,
        clues: [],
        // P2
        month: 1, trust: 10, skill: 10, currentOptions: []
    };

    // ==========================================
    // INITIALIZATION & HELPERS
    // ==========================================
    window.onload = function() { 
        document.getElementById('controls-p1').innerHTML = `<button class="primary" onclick="p1_startIntro()" style="width:100%">ğŸ”” æŒ‰é–€éˆ´ä¸¦è‡ªæˆ‘ä»‹ç´¹</button>`;
        addMsg('p1', 'sys', 'èª¿æŸ¥æ¨¡æ“¬é–‹å§‹ã€‚');
    }

    function addMsg(phase, type, text) {
        const container = document.getElementById(`chat-${phase}`);
        const div = document.createElement('div');
        div.className = `msg msg-${type}`;
        div.innerHTML = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addClue(text, type='neutral') {
        if(state.clues.includes(text)) return;
        state.clues.push(text);
        const div = document.createElement('div');
        div.className = `clue-entry ${type === 'alert' ? 'clue-alert' : ''}`;
        div.innerText = text;
        document.getElementById('clue-log').appendChild(div);
    }

    // ==========================================
    // PHASE 1: INVESTIGATION
    // ==========================================
    function p1_startIntro() {
        addMsg('p1', 'sw', 'æå…ˆç”Ÿæ‚¨å¥½ï¼Œæˆ‘æ˜¯ç¤¾å·¥ã€‚æ”¶åˆ°é€šå ±é—œå¿ƒå­©å­ç‹€æ³ã€‚');
        setTimeout(() => {
            addMsg('p1', 'parent', P1_DATA.parent.intro);
            addClue("å®¶é•·åˆæ¬¡æ¥è§¸é¡¯éœ²æ•µæ„", "alert");
            p1_renderControls();
        }, 800);
    }

    function p1_renderControls() {
        const c = document.getElementById('controls-p1');
        if(state.escalationTriggered) return;
        c.innerHTML = '';
        
        let html = `<div class="control-group">`;
        
        if(state.depthP.incident === 0) html += `<button onclick="p1_askIncident()">ğŸ¤• è©¢å•å‚·å‹¢ç¶“é</button>`;
        else if(state.depthP.incident === 1) html += `<button class="highlight" onclick="p1_pressIncident()">ğŸ” è¿½å•ï¼šè§£é‡‹ä¸åˆç†</button>`;
        
        if(state.childAccessStatus === 'pending') {
            html += `<button onclick="p1_reqChild_1()">ğŸ‘¶ è¦æ±‚æ¥è§¸å°å­©</button>`;
        } else if(state.childAccessStatus === 'blocked_1') {
            html += `</div><div class="msg-sys">å®¶é•·æ‹’çµ•ã€‚é¸æ“‡ç­–ç•¥ï¼š</div><div class="control-group">`;
            html += `<button class="btn-soft" onclick="p1_reqChild_2('soft')">ğŸ™ æŸ”æ€§å‹¸èªª</button>`;
            html += `<button class="btn-hard" onclick="p1_reqChild_2('hard')">âš–ï¸ å¼·ç¡¬æ³•è¦</button>`;
        } else if(state.childAccessStatus === 'blocked_2') {
            html += `</div><div class="msg-sys">æŒçºŒé˜»ç¤™ã€‚é¸æ“‡æ›¿ä»£æ–¹æ¡ˆï¼š</div><div class="control-group">`;
            html += `<button class="btn-fallback" onclick="p1_fallback('school')">ğŸ« å­¸æ ¡è¨ªè¦–</button>`;
            html += `<button class="btn-fallback" onclick="p1_fallback('supervised')">ğŸ‘€ å®¶é•·åœ¨å ´ç›£ç£</button>`;
            html += `<button class="btn-hard" onclick="p1_fallback('legal')">ğŸ‘® è­¦æ”¿å”åŠ©</button>`;
        }

        if(state.childAccessStatus === 'granted') {
            html += `<button class="finish-btn" onclick="openModal()">ğŸ“ è¨ªè«‡çµæŸï¼Œé€²å…¥è©•ä¼°</button>`;
        }

        html += `</div>`;
        c.innerHTML = html;
    }

    function p1_askIncident() {
        addMsg('p1', 'sw', 'å¯ä»¥èªªæ˜ä¸€ä¸‹å‚·å‹¢æ€éº¼ç™¼ç”Ÿçš„å—ï¼Ÿ');
        setTimeout(() => {
            addMsg('p1', 'parent', P1_DATA.parent.r_incident_0);
            addClue("å®¶é•·å°å‚·å‹¢è§£é‡‹å«ç³Š");
            state.depthP.incident = 1;
            p1_renderControls();
        }, 800);
    }

    function p1_pressIncident() {
        addMsg('p1', 'sw', 'ä½†é€™å‚·å‹¢ä½ç½®ä¸åƒæ˜¯æ„å¤–ï¼Œè«‹æ‚¨è€å¯¦èªªã€‚');
        setTimeout(() => {
            // Random trigger of attack
            if(Math.random() > 0.4) {
                state.escalationTriggered = true;
                addMsg('p1', 'parent', P1_DATA.parent.r_attack);
                addClue("å®¶é•·æŒæ­¦å™¨å¨è„…ç¤¾å·¥", "alert");
                document.getElementById('controls-p1').innerHTML = `
                    <div class="msg-danger">âš ï¸ å±éšªï¼šå®¶é•·æƒ…ç·’å¤±æ§ï¼</div>
                    <div class="control-group" style="justify-content:center; margin-top:10px;">
                        <button class="btn-retreat" onclick="p1_safety('retreat')">ğŸ›¡ï¸ æš«é›¢ç¾å ´ (è¯ç¹«ç£å°)</button>
                        <button class="btn-risk" onclick="p1_safety('stay')">ğŸ›‘ å¼·ç¡¬å …æŒ (é«˜é¢¨éšª)</button>
                    </div>`;
            } else {
                addMsg('p1', 'parent', P1_DATA.parent.r_incident_1);
                state.depthP.incident = 2;
                p1_renderControls();
            }
        }, 800);
    }

    function p1_safety(choice) {
        if(choice === 'retreat') {
            addMsg('p1', 'sw', 'ï¼ˆä¿æŒå†·éœï¼‰å¥½ï¼Œæˆ‘å…ˆå›è»Šä¸Šæ‹¿è³‡æ–™ã€‚');
            addMsg('p1', 'sys', 'å®‰å…¨æ’¤é›¢ã€‚ç¨å¾Œåœ¨è­¦æ–¹é™ªåŒä¸‹å®Œæˆè¨ªè¦–ã€‚');
            document.getElementById('d6').checked = true; // Unsafe env
        } else {
            addMsg('p1', 'sw', 'æŠŠæ±è¥¿æ”¾ä¸‹ï¼ä½ ç¾åœ¨æ˜¯å¦¨ç¤™å…¬å‹™ï¼');
            if(Math.random() > 0.5) {
                alert("æ¨¡æ“¬å¤±æ•—ï¼šç¤¾å·¥å—å‚·é€é†«ã€‚");
                location.reload();
                return;
            }
            addMsg('p1', 'sys', 'å®¶é•·è¢«éœ‡æ‡¾ï¼Œæ‘”æ±è¥¿å¾Œåä¸‹ã€‚');
        }
        state.escalationTriggered = false;
        p1_renderControls();
    }

    function p1_reqChild_1() {
        addMsg('p1', 'sw', 'æˆ‘éœ€è¦ç¢ºèªå­©å­å®‰å…¨ï¼Œè«‹è®“æˆ‘è¦‹ä»–ã€‚');
        setTimeout(() => {
            addMsg('p1', 'parent', P1_DATA.parent.r_child_deny_1);
            addClue("å®¶é•·åˆæ¬¡é˜»æ“‹æ¥è§¸å…’å°‘", "alert");
            state.childAccessStatus = 'blocked_1';
            p1_renderControls();
        }, 800);
    }

    function p1_reqChild_2(strategy) {
        if(strategy === 'soft') addMsg('p1', 'sw', 'æˆ‘å€‘åªæ˜¯çœ‹ä¸€çœ¼ç¢ºèªå¹³å®‰ï¼Œå¹¾åˆ†é˜å°±å¥½ï¼Œé€™æ¨£ä¹Ÿèƒ½ç›¡å¿«çµæ¡ˆã€‚');
        else addMsg('p1', 'sw', 'ä¾å…’å°‘æ¬Šæ³•ç¤¾å·¥æœ‰è¨ªè¦–æ¬Šã€‚è‹¥æŒçºŒé˜»ç¤™ï¼Œæˆ‘å€‘å¿…é ˆè«‹è­¦å¯Ÿåˆ°å ´ã€‚');

        setTimeout(() => {
            if(Math.random() > 0.3) { // High resistance
                addMsg('p1', 'parent', P1_DATA.parent.r_child_deny_2);
                state.childAccessStatus = 'blocked_2';
            } else {
                addMsg('p1', 'parent', P1_DATA.parent.r_reluctant);
                state.childAccessStatus = 'granted';
                p1_interviewChild('normal');
            }
            p1_renderControls();
        }, 800);
    }

    function p1_fallback(mode) {
        if(mode === 'school') {
            addMsg('p1', 'sw', 'æ—¢ç„¶ä¸æ–¹ä¾¿ï¼Œé‚£æˆ‘æ”¹å¤©å†ä¾†ã€‚');
            addMsg('p1', 'sys', 'éš”æ—¥æ–¼å­¸æ ¡è¨ªè¦–ã€‚');
            p1_interviewChild('school');
        } else if(mode === 'supervised') {
            addMsg('p1', 'sw', 'é‚£æ‚¨åœ¨æ—é‚Šçœ‹è‘—ï¼Œè®“æˆ‘ç¢ºèªå‚·å‹¢å°±å¥½ã€‚');
            addMsg('p1', 'parent', P1_DATA.parent.r_supervised);
            p1_interviewChild('supervised');
        } else {
            addMsg('p1', 'sw', 'æˆ‘å€‘æœƒæ­£å¼ç™¼å‡½ä¸¦è«‹è­¦å“¡é™ªåŒã€‚');
            addMsg('p1', 'sys', 'ä¸‰å¤©å¾Œè­¦åŠ›é™ªåŒå¼·åˆ¶é€²å…¥ã€‚');
            p1_interviewChild('normal');
        }
        state.childAccessStatus = 'granted';
        p1_renderControls();
    }

    function p1_interviewChild(mode) {
        let text = "";
        if(mode === 'supervised') {
            text = P1_DATA.child.supervised_verify;
            addClue("å®¶é•·åœ¨å ´ï¼Œå…’å°‘ä¸æ•¢åå¯¦", "alert");
        } else {
            text = P1_DATA.child.verify;
            addClue("å…’å°‘é€éœ²å—æš´äº‹å¯¦", "alert");
            document.getElementById('d1').checked = true;
        }
        setTimeout(() => addMsg('p1', 'child', text), 1000);
    }

    // ==========================================
    // TRANSITION
    // ==========================================
    function openModal() { document.getElementById('assessment-modal').style.display = 'block'; }
    function closeModal() { document.getElementById('assessment-modal').style.display = 'none'; }
    
    function submitDecision() {
        closeModal();
        const risk = document.querySelectorAll('#sdm-form h3:nth-of-type(2) + label input:checked').length > 0;
        if(risk) {
            alert("ã€ç³»çµ±è£å®šï¼šç·Šæ€¥å®‰ç½®ã€‘\né€²å…¥å®‰ç½®è™•é‡éšæ®µ (Phase 2)ã€‚");
            initPhase2();
        } else {
            alert("ã€ç³»çµ±è£å®šï¼šçµæ¡ˆã€‘");
            location.reload();
        }
    }

    // ==========================================
    // PHASE 2: PLACEMENT
    // ==========================================
    function initPhase2() {
        document.getElementById('view-phase1').classList.remove('active-view');
        document.getElementById('view-phase2').classList.add('active-view');
        document.getElementById('p1-sidebar').style.display = 'none';
        document.getElementById('p2-sidebar').style.display = 'block';
        p2_updateStats();
        p2_renderActions();
        addMsg('p2', 'sys', 'å®‰ç½®åˆæœŸã€‚è«‹é¸æ“‡æœ¬æœˆå·¥ä½œé‡é»ã€‚');
    }

    function p2_updateStats() {
        state.trust = Math.max(0, Math.min(100, state.trust));
        state.skill = Math.max(0, Math.min(100, state.skill));
        document.getElementById('txt-trust').innerText = state.trust + '%';
        document.getElementById('bar-trust').style.width = state.trust + '%';
        document.getElementById('txt-skill').innerText = state.skill + '%';
        document.getElementById('bar-skill').style.width = state.skill + '%';
        document.getElementById('txt-month').innerText = `Month ${state.month}/12`;
    }

    function p2_renderActions() {
        document.getElementById('controls-p2').innerHTML = `
            <div class="action-grid">
                <button onclick="p2_act('visit')"><span>ğŸ—£ï¸ æœƒé¢å®‰æ’</span><small>è¯ç¹«æ¢è¦–</small></button>
                <button onclick="p2_act('resource')"><span>ğŸ  è³‡æºé€£çµ</span><small>å”åŠ©ç’°å¢ƒ</small></button>
                <button onclick="p2_act('edu')"><span>ğŸ“š è¦ªè·æ•™è‚²</span><small>ç£ä¿ƒèª²ç¨‹</small></button>
            </div>
        `;
    }

    function p2_act(action) {
        // Random Mood Logic
        let rand = Math.random();
        let mood = 'hostile';
        if(rand < 0.1) mood = 'lost';
        else if(rand < 0.4) mood = 'hardship';
        else if(rand < 0.6) mood = 'coop';

        // Complaint Trigger (15% Chance if Hostile)
        if(mood === 'hostile' && Math.random() < 0.3) {
            p2_triggerComplaint();
            return;
        }

        let pool = P2_DATA[mood];
        let txt = pool[Math.floor(Math.random() * pool.length)];
        addMsg('p2', `parent mood-${mood}`, `<strong>${P1_DATA.parent.name}ï¼š</strong><br>${txt}`);
        p2_genOptions(mood);
    }

    function p2_triggerComplaint() {
        let txt = P2_DATA.complaint[Math.floor(Math.random() * P2_DATA.complaint.length)];
        addMsg('p2', 'parent mood-hostile', `<strong>${P1_DATA.parent.name} (çˆ†æ°£)ï¼š</strong><br>${txt}`);
        document.getElementById('controls-p2').innerHTML = `
            <div class="msg-danger">âš ï¸ å±æ©Ÿï¼šå®¶é•·æå‡ºæŠ•è¨´/å‘Šè¨´ï¼</div>
            <button class="sup-btn" onclick="p2_consultSup()">ğŸ“ è«®è©¢ç£å°</button>
        `;
    }

    function p2_consultSup() {
        addMsg('p2', 'sw', 'ï¼ˆæ’¥æ‰“é›»è©±ï¼‰ç£å°ï¼Œæ¡ˆçˆ¶è¦æŠ•è¨´æˆ‘ï¼Œç”šè‡³æå‘Šï¼Œæ€éº¼è¾¦ï¼Ÿ');
        setTimeout(() => {
            if(Math.random() > 0.5) {
                addMsg('p2', 'sup', '<strong>ç£å°ï¼š</strong>é€™ä»¶äº‹æˆ‘ä¾†è™•ç†ï¼Œæˆ‘æœƒè¦ªè‡ªè·Ÿä»–èªªæ˜ï¼Œä½ å…ˆå¿™åˆ¥çš„ã€‚');
                addMsg('p2', 'sys', 'ç£å°æœ‰æ•ˆä»‹å…¥ï¼Œå®¶é•·æ°£ç„°ç¨æ¸›ã€‚');
                state.trust += 5;
            } else {
                addMsg('p2', 'sup', '<strong>ç£å°ï¼š</strong>é€™æ˜¯æ­£å¸¸çš„åæŠ—ï¼Œä½ è‡ªå·±å†å»æ¾„æ¸…ä¸€ä¸‹è¨ªè¦–å¿…è¦æ€§å°±å¥½ã€‚');
                addMsg('p2', 'sys', 'ç£å°ç„¡æ•ˆå›æ‡‰ï¼Œå£“åŠ›å€å¢ã€‚');
                state.trust -= 5;
            }
            p2_updateStats();
            document.getElementById('controls-p2').innerHTML = `<button class="primary" style="width:100%" onclick="p2_next()">ğŸ“… çµç®—æœ¬æœˆ</button>`;
        }, 1000);
    }

    function p2_genOptions(mood) {
        const c = document.getElementById('controls-p2');
        const getR = (arr) => arr[Math.floor(Math.random() * arr.length)];
        let opts = [
            { text: getR(SW_OPTIONS.strict), dT: -5, dS: +5 },
            { text: getR(SW_OPTIONS.soft), dT: +5, dS: +5 }
        ];
        if(Math.random() > 0.7) opts.push({ text: getR(SW_OPTIONS.mistake), dT: -15, dS: -5 });
        
        opts.sort(() => Math.random() - 0.5);
        state.currentOptions = opts;

        let html = opts.map((o, i) => 
            `<button class="btn-dialogue" onclick="p2_handle(${i})"><strong>(ç¤¾å·¥)</strong> "${o.text}"</button>`
        ).join('');
        c.innerHTML = `<div class="response-grid">${html}</div>`;
    }

    function p2_handle(idx) {
        let o = state.currentOptions[idx];
        addMsg('p2', 'sw', `<strong>æˆ‘ï¼š</strong><br>${o.text}`);
        state.trust += o.dT;
        state.skill += o.dS;
        p2_updateStats();
        document.getElementById('controls-p2').innerHTML = `<button class="primary" style="width:100%" onclick="p2_next()">ğŸ“… ä¸‹å€‹æœˆ</button>`;
    }

    function p2_next() {
        state.month++;
        if(state.month > 12) {
            let res = (state.skill > 60 && state.trust > 50) ? "æ¼¸é€²å¼è¿”å®¶" : "åœæ­¢è¦ªæ¬Š";
            addMsg('p2', 'sys', `è©•ä¼°çµæŸã€‚çµæœï¼š${res}`);
            document.getElementById('controls-p2').innerHTML = `<button class="primary" onclick="location.reload()">ğŸ”„ é‡ç½®</button>`;
        } else {
            p2_updateStats();
            addMsg('p2', 'sys', `--- ç¬¬ ${state.month} å€‹æœˆ ---`);
            p2_renderActions();
        }
    }
</script>
</body>
</html>